#!/usr/bin/env python3
# coding: utf-8
"""
EpiMind ‚Äî IAAM Predictor cu OCR-NLP (Versiune CompletƒÉ IntegratƒÉ)
UMF "Grigore T. Popa" Ia»ôi ‚Äî Dr. Boghian Lucian
Version: 2.3.0 ‚Äî OCR-NLP Integration

ADƒÇUGƒÇRI NOI:
- OCR pentru documente medicale
- NLP pentru extragerea automatƒÉ de valori
- Auto-completare formular
- Procesare √Æn limba rom√¢nƒÉ »ôi englezƒÉ

RuleazƒÉ:
    streamlit run IAAM_PREDICTOR.py
"""

from __future__ import annotations

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import json
import numpy as np
from datetime import datetime
from pathlib import Path
import os
import re
from typing import Dict, List, Tuple, Any, Optional

# Import-uri OCR/NLP (cu fallback pentru sisteme fƒÉrƒÉ aceste dependin»õe)
try:
    import pytesseract
    import cv2
    import spacy
    from PIL import Image, ImageEnhance
    OCR_AVAILABLE = True
    st.success("‚úÖ OCR-NLP disponibil »ôi func»õional!")
except ImportError as e:
    OCR_AVAILABLE = False
    st.warning(f"‚ö†Ô∏è OCR-NLP nu este disponibil: {e}")
    st.info("üí° Pentru func»õionalitate completƒÉ, instala»õi: pip install pytesseract opencv-python spacy Pillow")

# ---------------- App configuration ----------------
APP_TITLE = "EpiMind ‚Äî IAAM Predictor cu OCR-NLP"
APP_ICON = "üè•"
VERSION = "2.3.0"
AUDIT_CSV = "epimind_audit.csv"
EXPORT_DIR = Path("exports")
EXPORT_DIR.mkdir(exist_ok=True)

st.set_page_config(page_title=APP_TITLE, page_icon=APP_ICON, layout="wide", initial_sidebar_state="collapsed")

# ---------------- Enhanced CSS (cu stiluri pentru OCR) ----------------
st.markdown(
    """
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{--bg:#071019;--card:#0f1720;--muted:#9fb0c6;--accent:#1f78d1;--accent-2:#00a859;--danger:#dc2626;--success:#10b981;--warning:#f59e0b;}
    body {background: linear-gradient(180deg,#061018,#08121a) !important; color: #EAF2FF;}
    .stApp { font-family: 'Inter', sans-serif; }
    .header { padding:12px; border-radius:10px; background: linear-gradient(90deg, rgba(31,120,209,0.04), rgba(0,168,89,0.02)); margin-bottom:12px; border:1px solid rgba(255,255,255,0.02);}    
    .title { font-weight:700; font-size:20px; color:#EAF2FF; }
    .subtitle { color:var(--muted); font-size:13px; margin-top:4px }
    .card { background: var(--card); border-radius:10px; padding:14px; border:1px solid rgba(255,255,255,0.02); color:#EAF2FF; }
    .metric { text-align:center; padding:8px; border-radius:8px; background: rgba(255,255,255,0.01); }
    .metric-value { font-weight:800; font-size:26px; color:var(--accent); }
    .small-muted { color: var(--muted); font-size:12px; }
    .risk-alert { padding:12px; border-radius:8px; font-weight:700; margin-bottom:8px; }
    .risk-critical { background: rgba(220,38,38,0.08); border-left:4px solid var(--danger); color:#fecaca; }
    .risk-high { background: rgba(245,158,11,0.06); border-left:4px solid #F59E0B; color:#fff4d1; }
    .risk-moderate { background: rgba(59,130,246,0.05); border-left:4px solid #3B82F6; color:#cfe6ff; }
    .risk-low { background: rgba(16,185,129,0.05); border-left:4px solid #10B981; color:#d7ffe6; }
    .muted-box { background: rgba(255,255,255,0.01); border-radius:8px; padding:8px; }
    
    /* Stiluri OCR specifice */
    .ocr-preview {
        border: 2px dashed var(--accent);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: rgba(31, 120, 209, 0.05);
        margin: 10px 0;
    }
    .ocr-result { background: var(--card); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid var(--success); }
    .confidence-high { color: var(--success); font-weight: 600; }
    .confidence-medium { color: var(--warning); font-weight: 600; }
    .confidence-low { color: var(--danger); font-weight: 600; }
    .extraction-value { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
    @media (max-width: 760px) {
      .title { font-size:18px; }
      .metric-value { font-size:20px; }
      .card { padding:10px; }
    }
    </style>
    """,
    unsafe_allow_html=True,
)

# ---------------- OCR/NLP Classes ----------------

class MedicalOCRProcessor:
    """Procesor OCR pentru documente medicale"""
    
    def __init__(self):
        if not OCR_AVAILABLE:
            return
        self.ocr_config = r'--oem 3 --psm 6 -l ron+eng'
        
    def preprocess_image(self, image: Image.Image) -> np.ndarray:
        """PreproceseazƒÉ imaginea pentru OCR mai bun"""
        if not OCR_AVAILABLE:
            return np.array([])
            
        # Converte»ôte la numpy array
        img_array = np.array(image)
        
        # Converte»ôte la grayscale
        if len(img_array.shape) == 3:
            gray = cv2.cvtColor(img_array, cv2.COLOR_RGB2GRAY)
        else:
            gray = img_array
            
        # Aplicare filtre pentru √ÆmbunƒÉtƒÉ»õire
        denoised = cv2.medianBlur(gray, 3)
        
        # Aumentare contrast
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
        enhanced = clahe.apply(denoised)
        
        # Binarizare adaptivƒÉ
        binary = cv2.adaptiveThreshold(
            enhanced, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, 
            cv2.THRESH_BINARY, 11, 2
        )
        
        return binary
    
    def extract_text(self, image: Image.Image) -> str:
        """Extrage textul din imagine folosind OCR"""
        if not OCR_AVAILABLE:
            return ""
            
        try:
            processed_img = self.preprocess_image(image)
            text = pytesseract.image_to_string(processed_img, config=self.ocr_config)
            return text.strip()
        except Exception as e:
            st.error(f"Eroare OCR: {str(e)}")
            return ""
    
    def process_medical_document(self, uploaded_file) -> Dict[str, Any]:
        """ProceseazƒÉ document medical »ôi extrage date relevante"""
        if not OCR_AVAILABLE:
            return {"error": "OCR nu este disponibil", "success": False}
            
        try:
            image = Image.open(uploaded_file)
            text = self.extract_text(image)
            
            if text:
                extracted_data = self.extract_medical_values(text)
                return {
                    "text": text,
                    "extracted_data": extracted_data,
                    "success": True,
                    "confidence": self.estimate_quality(text)
                }
            else:
                return {"error": "Nu s-a putut extrage text", "success": False}
                
        except Exception as e:
            return {"error": str(e), "success": False}
    
    def extract_medical_values(self, text: str) -> Dict[str, Any]:
        """Extrage valori medicale din text"""
        text_lower = text.lower()
        values = {}
        
        # Patterns pentru valorile importante
        patterns = {
            'wbc': [
                r'(?:leucocite|wbc|gb)[:\s]*(\d+(?:\.\d+)?)',
                r'(\d+(?:\.\d+)?)\s*(?:x\s*)?10\^?3\s*/?Œºl.*leucocite',
            ],
            'crp': [
                r'crp[:\s]*(\d+(?:\.\d+)?)',
                r'proteina\s+c\s+reactiva[:\s]*(\d+(?:\.\d+)?)',
            ],
            'procalcitonina': [
                r'procalcitonina[:\s]*(\d+(?:\.\d+)?)',
                r'pct[:\s]*(\d+(?:\.\d+)?)',
            ],
            'temperatura': [
                r'(?:temperatura|temp)[:\s]*(\d+(?:\.\d+)?)\s*¬∞?c?',
                r'(\d+(?:\.\d+)?)\s*¬∞c',
            ],
            'fc': [
                r'(?:puls|fc|hr)[:\s]*(\d+)',
                r'frecventa\s+cardiaca[:\s]*(\d+)',
            ],
            'hemoglobina': [
                r'(?:hemoglobina|hgb?)[:\s]*(\d+(?:\.\d+)?)',
            ],
            'creatinina': [
                r'creatinina[:\s]*(\d+(?:\.\d+)?)',
            ],
        }
        
        for key, pattern_list in patterns.items():
            for pattern in pattern_list:
                match = re.search(pattern, text_lower)
                if match:
                    try:
                        values[key] = float(match.group(1))
                        break  # Prima valoare gƒÉsitƒÉ
                    except (ValueError, IndexError):
                        continue
        
        # Pattern special pentru tensiune arterialƒÉ
        tas_pattern = r'(?:ta|tensiune|bp)[:\s]*(\d+)/(\d+)'
        tas_match = re.search(tas_pattern, text_lower)
        if tas_match:
            try:
                values['tas'] = int(tas_match.group(1))
                values['tad'] = int(tas_match.group(2))
            except (ValueError, IndexError):
                pass
        
        # CƒÉutare bacterii
        bacteria_patterns = [
            (r'escherichia\s+coli|e\.?\s*coli', 'Escherichia coli'),
            (r'klebsiella\s+pneumoniae', 'Klebsiella pneumoniae'),
            (r'pseudomonas\s+aeruginosa', 'Pseudomonas aeruginosa'),
            (r'staphylococcus\s+aureus', 'Staphylococcus aureus'),
            (r'acinetobacter\s+baumannii', 'Acinetobacter baumannii'),
        ]
        
        for pattern, name in bacteria_patterns:
            if re.search(pattern, text_lower):
                values['bacteria_found'] = True
                values['bacteria_name'] = name
                break
        
        # CƒÉutare rezisten»õe
        resistance_patterns = [
            (r'esbl\+?|extended.spectrum', 'ESBL'),
            (r'mrsa|methicillin.resistant', 'MRSA'),
            (r'vre|vancomycin.resistant', 'VRE'),
            (r'cre|carbapenem.resistant', 'CRE'),
        ]
        
        resistances = []
        for pattern, name in resistance_patterns:
            if re.search(pattern, text_lower):
                resistances.append(name)
        
        if resistances:
            values['resistances'] = resistances
        
        return values
    
    def estimate_quality(self, text: str) -> int:
        """EstimeazƒÉ calitatea extragerii OCR (0-100)"""
        if not text:
            return 0
        
        score = 0
        
        # Lungime text rezonabilƒÉ
        if 50 <= len(text) <= 5000:
            score += 25
        elif len(text) < 50:
            score += 10
        
        # Prezen»õa cuvintelor medicale
        medical_words = ['pacient', 'analiza', 'rezultat', 'valoare', 'normal', 'crescut', 'laborator']
        found_medical = sum(1 for word in medical_words if word.lower() in text.lower())
        score += min(found_medical * 5, 25)
        
        # Prezen»õa numerelor
        numbers = re.findall(r'\d+(?:\.\d+)?', text)
        if numbers:
            score += min(len(numbers) * 2, 25)
        
        # Absen»õa caracterelor ciudate
        weird_chars = len(re.findall(r'[^\w\s\.,;:()/%-¬∞]', text))
        if weird_chars < len(text) * 0.05:
            score += 25
        else:
            score += 10
        
        return min(score, 100)

@st.cache_resource
def get_ocr_processor():
    """Ini»õializeazƒÉ procesorul OCR (cached pentru performan»õƒÉ)"""
    return MedicalOCRProcessor()

# ---------------- Domain knowledge (pƒÉstrat din original) ----------------
REZISTENTA_PROFILE = {
    "Escherichia coli": ["ESBL", "CRE", "AmpC", "NDM-1", "CTX-M"],
    "Klebsiella pneumoniae": ["ESBL", "CRE", "KPC", "NDM", "OXA-48"],
    "Pseudomonas aeruginosa": ["MDR", "XDR", "PDR"],
    "Acinetobacter baumannii": ["OXA-23", "OXA-24", "MDR"],
    "Staphylococcus aureus": ["MRSA", "VISA"],
    "Enterococcus faecalis": ["VRE"],
    "Candida auris": ["Fluconazol-R", "Echinocandin-R"]
}

ICD_CODES = {
    "Bacteriemie/Septicemie": "A41.9",
    "Pneumonie nosocomialƒÉ": "J15.9",
    "ITU nosocomialƒÉ": "N39.0",
    "Infec»õie CVC": "T80.2",
    "Infec»õie plagƒÉ operatorie": "T81.4",
    "Clostridioides difficile": "A04.7",
}

# PƒÉstra»õi COMORBIDITATI din fi»ôierul original...
COMORBIDITATI = {
    "Cardiovascular": {
        "Hipertensiune arterialƒÉ": {"ControlatƒÉ": 3, "NecontrolatƒÉ": 6, "CrizƒÉ HTA": 12},
        "Insuficien»õƒÉ cardiacƒÉ": {"NYHA I": 3, "NYHA II": 5, "NYHA III": 10, "NYHA IV": 15},
        "Cardiopatie ischemicƒÉ": {"StabilƒÉ": 5, "InstabilƒÉ": 10},
        "Infarct miocardic anterior": 8,
        "Interven»õii coronariene": {"PCI": 5, "CABG": 7},
        "Aritmii": {"FA paroxisticƒÉ": 5, "FA permanentƒÉ": 7, "TV/TVS": 10},
        "Valvulopatii semnificative": 8,
        "BoalƒÉ arterialƒÉ perifericƒÉ": 7,
        "Tromboembolism venos (ISTORIC)": 6
    },
    "Respirator": {
        "BPOC": {"GOLD I": 3, "GOLD II": 5, "GOLD III": 10, "GOLD IV": 15},
        "Astm bron»ôic": {"Controlat": 3, "Par»õial controlat": 5, "Necontrolat": 8},
        "FibrozƒÉ pulmonarƒÉ": 12,
        "Pneumopatie intersti≈£ialƒÉ": 10,
        "HTAP (hipertensiune pulmonarƒÉ)": 12,
        "Sindrom apnee somn (SAS)": 5,
        "Bron»ôiectazii": 7,
        "TuberculozƒÉ pulmonarƒÉ (istoric/activ)": {"Istoric": 3, "ActivƒÉ": 10}
    },
    "Metabolic": {
        "Diabet zaharat": {"Tip 1": 10, "Tip 2 controlat": 5, "Tip 2 necontrolat": 12, "Cu complica»õii micro/macrovasculare": 15},
        "Obezitate": {"BMI 25-30": 2, "BMI 30-35": 3, "BMI 35-40": 5, "BMI >40": 8},
        "Sindrom metabolic": 6,
        "Dislipidemie": 3,
        "SteatozƒÉ/NAFLD": 4,
        "Guta/hiperuricemie": 4
    },
    # ... (pƒÉstra»õi restul categoriilor din fi»ôierul original)
}

# ---------------- Calculators (pƒÉstra»õi din original) ----------------
def calculate_sofa_detailed(data: Dict[str, Any]) -> Tuple[int, Dict[str, int]]:
    """Calculate an extended SOFA score with component breakdown."""
    components = {"Respirator": 0, "Coagulare": 0, "Hepatic": 0, "Cardiovascular": 0, "SNC": 0, "Renal": 0}
    pao2_fio2 = data.get("pao2_fio2", 400)
    if pao2_fio2 < 400:
        components["Respirator"] = 1
    if pao2_fio2 < 300:
        components["Respirator"] = 2
    if pao2_fio2 < 200:
        components["Respirator"] = 3
    if pao2_fio2 < 100:
        components["Respirator"] = 4

    platelets = data.get("trombocite", 200)
    if platelets < 150:
        components["Coagulare"] = 1
    if platelets < 100:
        components["Coagulare"] = 2
    if platelets < 50:
        components["Coagulare"] = 3
    if platelets < 20:
        components["Coagulare"] = 4

    bilirubin = data.get("bilirubina", 1.0)
    if bilirubin >= 1.2:
        components["Hepatic"] = 1
    if bilirubin >= 2.0:
        components["Hepatic"] = 2
    if bilirubin >= 6.0:
        components["Hepatic"] = 3
    if bilirubin >= 12.0:
        components["Hepatic"] = 4

    if data.get("hipotensiune"):
        components["Cardiovascular"] = max(components["Cardiovascular"], 2)
    if data.get("vasopresoare"):
        components["Cardiovascular"] = max(components["Cardiovascular"], 3)

    glasgow = data.get("glasgow", 15)
    if glasgow < 15:
        components["SNC"] = 1
    if glasgow < 13:
        components["SNC"] = 2
    if glasgow < 10:
        components["SNC"] = 3
    if glasgow < 6:
        components["SNC"] = 4

    creatinine = data.get("creatinina", 1.0)
    urine_output = data.get("diureza_ml_kg_h", 1.0)
    if creatinine >= 1.2 or urine_output < 0.5:
        components["Renal"] = 1
    if creatinine >= 2.0:
        components["Renal"] = 2
    if creatinine >= 3.5 or urine_output < 0.3:
        components["Renal"] = 3
    if creatinine >= 5.0 or urine_output < 0.1:
        components["Renal"] = 4

    total = sum(components.values())
    return total, components

def calculate_qsofa(data: Dict[str, Any]) -> int:
    """Compute qSOFA: TAS<100, FR>=22, Glasgow<15"""
    score = 0
    tas = data.get("tas", 120)
    fr = data.get("fr", 18)
    glasgow = data.get("glasgow", 15)
    if tas < 100:
        score += 1
    if fr >= 22:
        score += 1
    if glasgow < 15:
        score += 1
    return score

# PƒÉstra»õi toate celelalte func»õii din fi»ôierul original...
# (calculate_apache_like, analyze_urinary_sediment, etc.)

def score_laboratory_markers(labs: Dict[str, Any]) -> Tuple[int, List[str]]:
    """
    Evaluate key laboratory markers and return a numeric lab score plus descriptive lines.
    """
    score = 0
    lines: List[str] = []

    if not labs:
        return 0, ["FƒÉrƒÉ analize disponibile"]

    # WBC
    wbc = labs.get('wbc')
    if wbc is not None:
        try:
            w = float(wbc)
            if w >= 12:
                score += 10
                lines.append(f"LeucocitozƒÉ: WBC {w} (>12) +10")
            elif w < 4:
                score += 10
                lines.append(f"Leucopenie: WBC {w} (<4) +10")
            else:
                lines.append(f"WBC: {w} (normal) +0")
        except Exception:
            lines.append(f"WBC: valoare nevalidƒÉ: {wbc}")

    # CRP
    crp = labs.get('crp')
    if crp is not None:
        try:
            c = float(crp)
            if c >= 100:
                score += 15; lines.append(f"CRP {c} mg/L ‚Äî mare inflama»õie (+15)")
            elif c >= 50:
                score += 8; lines.append(f"CRP {c} mg/L ‚Äî moderat (+8)")
            else:
                lines.append(f"CRP {c} mg/L ‚Äî scƒÉzut (+0)")
        except Exception:
            lines.append(f"CRP: valoare nevalidƒÉ: {crp}")

    # Procalcitonin
    pct = labs.get('procalcitonina') or labs.get('pct')
    if pct is not None:
        try:
            p = float(pct)
            if p >= 2.0:
                score += 20; lines.append(f"ProcalcitoninƒÉ {p} ng/mL ‚Äî mare probabilitate infec»õie severƒÉ (+20)")
            elif p >= 0.5:
                score += 10; lines.append(f"ProcalcitoninƒÉ {p} ng/mL ‚Äî sugestivƒÉ (+10)")
            else:
                lines.append(f"ProcalcitoninƒÉ {p} ng/mL ‚Äî scƒÉzutƒÉ (+0)")
        except Exception:
            lines.append(f"PCT: valoare nevalidƒÉ: {pct}")

    score = max(0, int(score))
    return score, lines

# ---------------- Core IAAM engine (pƒÉstrat + enhanced cu OCR data) ----------------
def calculate_iaam_risk(payload: Dict[str, Any]) -> Tuple[int, str, List[str], List[str]]:
    """Deterministic IAAM risk engine extended with laboratory markers."""
    hours = payload.get("ore_spitalizare", 0) or 0
    details: List[str] = []
    score = 0

    if hours < 48:
        return 0, "NU IAAM (temporal)", [f"Internare {hours}h <48h: criteriu temporal negat"], ["Monitorizare clinicƒÉ"]

    # Temporal
    if 48 <= hours < 72:
        score += 5; details.append(f"Timp spitalizare: {hours}h (+5)")
    elif hours < 168:
        score += 10; details.append(f"Timp spitalizare: {hours}h (+10)")
    else:
        score += 15; details.append(f"Timp spitalizare: {hours}h (+15)")

    # Devices
    device_weights = {"CVC": 20, "Ventilatie": 25, "Sonda urinara": 15, "Traheostomie": 20, "Drenaj": 10, "PEG": 12}
    for dev, info in (payload.get("dispozitive") or {}).items():
        if info.get("prezent"):
            zile = info.get("zile", 0) or 0
            base = device_weights.get(dev, 5)
            extra = 10 if zile > 7 else 5 if zile > 3 else 0
            add = base + extra
            score += add
            details.append(f"{dev} ({zile} zile): +{add}")

    # Microbiology
    if payload.get("cultura_pozitiva"):
        agent = payload.get("bacterie", "")
        score += 15
        details.append(f"CulturƒÉ pozitivƒÉ: {agent} (+15)")
        for rez in (payload.get("profil_rezistenta") or []):
            rez_pts = {"ESBL": 15, "CRE": 25, "KPC": 30, "NDM": 35, "MRSA": 20, "VRE": 25, "XDR": 30, "PDR": 40}.get(rez, 10)
            score += rez_pts
            details.append(f"Rezisten»õƒÉ {rez}: +{rez_pts}")

    # Severity scores
    sofa_val, sofa_comp = calculate_sofa_detailed(payload)
    if sofa_val > 0:
        score += sofa_val * 3
        details.append(f"SOFA: {sofa_val} (+{sofa_val*3})")

    qsofa_val = calculate_qsofa(payload)
    if qsofa_val >= 2:
        score += 15
        details.append(f"qSOFA: {qsofa_val} (+15)")

    # Laboratory markers
    lab_score, lab_lines = score_laboratory_markers(payload.get('analize', {}))
    if lab_score > 0:
        score += lab_score
        details.append(f"Markeri biologici: +{lab_score}")
        details.extend(lab_lines)

    # Final level & recommendations
    if score >= 120:
        level = "CRITIC"
        recs = [
            "Izolare imediatƒÉ »ôi notificare CPIAAM",
            "Consult infec»õionist urgent",
            "Recoltare probe »ôi ini»õiere ATB empiricƒÉ largƒÉ conform protocoalelor locale",
            "Monitorizare intensivƒÉ »ôi considerare terapie suport (vasopresoare, ventila»õie)"
        ]
    elif score >= 90:
        level = "FOARTE √éNALT"
        recs = ["Consult infec»õionist √Æn 2h", "Recoltare culturi »ôi antibiogramƒÉ", "Izolare preventivƒÉ"]
    elif score >= 60:
        level = "√éNALT"
        recs = ["Supraveghere activƒÉ IAAM", "Recoltare culturi »õintite", "Monitorizare parametri la 8h"]
    elif score >= 35:
        level = "MODERAT"
        recs = ["Monitorizare extinsƒÉ", "Documentare completƒÉ √Æn fi»ôa de observa»õie"]
    else:
        level = "SCƒÇZUT"
        recs = ["Monitorizare standard", "Precau»õii standard"]

    return int(score), level, details, recs

# ---------------- Helpers (pƒÉstra»õi din original) ----------------
def init_defaults():
    """Initialize session state defaults"""
    defaults = {
        'nume_pacient': 'Pacient_001', 'cnp': '', 'sectie': 'ATI',
        'ore_spitalizare': 96, 'pao2_fio2': 400, 'trombocite': 200,
        'bilirubina': 1.0, 'glasgow': 15, 'creatinina': 1.0,
        'hipotensiune': False, 'vasopresoare': False,
        'tas': 120, 'fr': 18, 'cultura_pozitiva': False,
        'bacterie': '', 'profil_rezistenta': [], 'tip_infectie': list(ICD_CODES.keys())[0],
        'comorbiditati_selectate': {}, 'analiza_urina': False, 'sediment': {},
        'analize': {}, 'show_nav': True, 'current_page': 'home', 'last_result': None
    }
    for k, v in defaults.items():
        if k not in st.session_state:
            st.session_state[k] = v

def collect_payload() -> Dict[str, Any]:
    """Gather current session state into a structured payload"""
    payload = {
        'nume_pacient': st.session_state.get('nume_pacient'),
        'cnp': st.session_state.get('cnp'),
        'sectie': st.session_state.get('sectie'),
        'ore_spitalizare': st.session_state.get('ore_spitalizare'),
        'dispozitive': {},
        'pao2_fio2': st.session_state.get('pao2_fio2'),
        'trombocite': st.session_state.get('trombocite'),
        'bilirubina': st.session_state.get('bilirubina'),
        'glasgow': st.session_state.get('glasgow'),
        'creatinina': st.session_state.get('creatinina'),
        'hipotensiune': st.session_state.get('hipotensiune'),
        'vasopresoare': st.session_state.get('vasopresoare'),
        'tas': st.session_state.get('tas'),
        'fr': st.session_state.get('fr'),
        'cultura_pozitiva': st.session_state.get('cultura_pozitiva'),
        'bacterie': st.session_state.get('bacterie'),
        'profil_rezistenta': st.session_state.get('profil_rezistenta'),
        'tip_infectie': st.session_state.get('tip_infectie'),
        'comorbiditati': st.session_state.get('comorbiditati_selectate'),
        'analiza_urina': st.session_state.get('analiza_urina'),
        'sediment': st.session_state.get('sediment'),
        'analize': st.session_state.get('analize', {}),
    }
    devices = ['CVC', 'Ventilatie', 'Sonda urinara', 'Traheostomie', 'Drenaj', 'PEG']
    for d in devices:
        payload['dispozitive'][d] = {
            'prezent': st.session_state.get(f"disp_{d}", False),
            'zile': st.session_state.get(f"zile_{d}", 0)
        }
    return payload

# ---------------- OCR Integration Functions ----------------

def apply_ocr_data_to_form(extracted_data: Dict[str, Any]):
    """AplicƒÉ datele extrase OCR √Æn formularul EpiMind"""
    
    # ActualizeazƒÉ valorile √Æn session state
    if 'wbc' in extracted_data:
        if 'analize' not in st.session_state:
            st.session_state['analize'] = {}
        st.session_state['analize']['wbc'] = extracted_data['wbc']
        st.session_state['lab_wbc'] = extracted_data['wbc']
    
    if 'crp' in extracted_data:
        if 'analize' not in st.session_state:
            st.session_state['analize'] = {}
        st.session_state['analize']['crp'] = extracted_data['crp']
        st.session_state['lab_crp'] = extracted_data['crp']
    
    if 'procalcitonina' in extracted_data:
        if 'analize' not in st.session_state:
            st.session_state['analize'] = {}
        st.session_state['analize']['pct'] = extracted_data['procalcitonina']
        st.session_state['lab_pct'] = extracted_data['procalcitonina']
    
    if 'temperatura' in extracted_data:
        st.session_state['temperatura'] = extracted_data['temperatura']
    
    if 'fc' in extracted_data:
        st.session_state['fc'] = extracted_data['fc']
    
    if 'tas' in extracted_data:
        st.session_state['tas'] = extracted_data['tas']
    
    if 'tad' in extracted_data:
        st.session_state['tad'] = extracted_data['tad']
    
    if 'hemoglobina' in extracted_data:
        if 'analize' not in st.session_state:
            st.session_state['analize'] = {}
        st.session_state['analize']['hemoglobina'] = extracted_data['hemoglobina']
    
    if 'creatinina' in extracted_data:
        st.session_state['creatinina'] = extracted_data['creatinina']
    
    # Bacterii
    if extracted_data.get('bacteria_found'):
        st.session_state['cultura_pozitiva'] = True
        if 'bacteria_name' in extracted_data:
            st.session_state['bacterie'] = extracted_data['bacteria_name']
    
    # Rezisten»õe
    if 'resistances' in extracted_data:
        st.session_state['profil_rezistenta'] = extracted_data['resistances']

# ---------------- UI: header, nav, pages (updated cu OCR) ----------------

def render_header():
    st.markdown('<div class="header">', unsafe_allow_html=True)
    cols = st.columns([0.6, 4])
    with cols[0]:
        if st.button("‚ò∞", key='toggle_nav_short'):
            st.session_state['show_nav'] = not st.session_state.get('show_nav', True)
        st.markdown('<div style="font-size:12px;color:#9fb0c6;margin-top:6px;">Meniu</div>', unsafe_allow_html=True)
    with cols[1]:
        st.markdown(f'<div class="title">{APP_TITLE} <span style="font-weight:400;font-size:12px;color:#9fb0c6">v{VERSION}</span></div>', unsafe_allow_html=True)
        ocr_status = "üü¢ OCR-NLP Activ" if OCR_AVAILABLE else "üü° OCR-NLP Indisponibil"
        st.markdown(f'<div class="subtitle">PlatformƒÉ demonstrativƒÉ ‚Äî evaluare predictivƒÉ IAAM cu inteligen»õƒÉ artificialƒÉ. {ocr_status}</div>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)

def render_nav():
    menu = [
        ("üè† Pagina principalƒÉ", "home"),
        ("üßæ Date pacient", "patient"),
        ("üìÑ OCR Document", "ocr"),  # PAGINƒÇ NOUƒÇ
        ("ü©∫ Dispozitive invazive", "devices"),
        ("üìä Scoruri severitate", "severity"),
        ("üß´ Microbiologie", "microbio"),
        ("‚öïÔ∏è ComorbiditƒÉ»õi", "comorbid"),
        ("üî¨ AnalizƒÉ urinarƒÉ", "urine"),
        ("üß™ Analize laborator", "analize"),
        ("üìã Rezultate & Istoric", "results"),
    ]
    st.markdown('<div class="card">', unsafe_allow_html=True)
    for label, key in menu:
        if st.button(label, key=f"nav_{key}" + str(key)):
            st.session_state['current_page'] = key
    st.markdown('</div>', unsafe_allow_html=True)

# ---------------- Pagina OCR (NOUƒÇ) ----------------

def page_ocr():
    """Pagina pentru procesarea OCR a documentelor medicale"""
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>üìÑ OCR Document Medical - Extragere AutomatƒÉ Date</h4>', unsafe_allow_html=True)
    
    if not OCR_AVAILABLE:
        st.error("üö´ Func»õionalitatea OCR nu este disponibilƒÉ!")
        st.markdown("**Pentru a activa OCR-NLP, instala»õi dependin»õele:**")
        st.code("""
pip install pytesseract opencv-python spacy Pillow
python -m spacy download ro_core_news_sm
python -m spacy download en_core_web_sm

# Windows: Instala»õi Tesseract de la:
# https://github.com/UB-Mannheim/tesseract/wiki
        """)
        st.info("üí° DupƒÉ instalare, reporni»õi aplica»õia pentru a activa func»õionalitatea OCR.")
        st.markdown('</div>', unsafe_allow_html=True)
        return
    
    # Ini»õializare procesor OCR
    ocr_processor = get_ocr_processor()
    
    # Upload document
    st.markdown("**üì§ Upload document medical**")
    st.markdown('<div class="small-muted">Tipuri acceptate: analize de laborator, rezultate microbiologice, fi»ôe de observa»õie, rapoarte imagistice</div>', unsafe_allow_html=True)
    
    uploaded_file = st.file_uploader(
        "Selecta»õi fi»ôier imagine", 
        type=['png', 'jpg', 'jpeg', 'bmp', 'tiff'],
        help="Formate suportate: PNG, JPG, JPEG, BMP, TIFF"
    )
    
    if uploaded_file:
        try:
            image = Image.open(uploaded_file)
            
            # Layout √Æn douƒÉ coloane
            col1, col2 = st.columns([3, 2])
            
            with col1:
                # Afi»ôare imagine cu dimensiune optimƒÉ
                display_img = image.copy()
                display_img.thumbnail((800, 600))
                st.image(display_img, caption=f"üìÑ {uploaded_file.name}", use_column_width=True)
            
            with col2:
                st.markdown("**üîß Ac»õiuni:**")
                
                # SetƒÉri OCR
                with st.expander("‚öôÔ∏è SetƒÉri OCR Avansate"):
                    ocr_lang = st.selectbox("Limba OCR", ["ron+eng", "eng", "ron"], index=0, help="Rom√¢nƒÉ + EnglezƒÉ pentru rezultate optime")
                    enhance_image = st.checkbox("√émbunƒÉtƒÉ»õire imagine", value=True, help="AplicƒÉ filtre pentru OCR mai bun")
                    confidence_threshold = st.slider("Prag √Æncredere", 30, 90, 50, help="Minimum confidence pentru acceptarea textului")
                
                # Buton procesare principalƒÉ
                if st.button("üîç ProceseazƒÉ Document", key="process_ocr", type="primary"):
                    with st.spinner("ü§ñ Extrag text »ôi analizez valorile medicale..."):
                        result = ocr_processor.process_medical_document(uploaded_file)
                        st.session_state['ocr_result'] = result
                        
                        if result.get('success'):
                            st.success(f"‚úÖ Document procesat! √éncredere: {result.get('confidence', 0)}%")
                        else:
                            st.error(f"‚ùå Eroare: {result.get('error', 'Eroare necunoscutƒÉ')}")
                
                # Informa»õii document
                st.markdown("**üìä Info Document:**")
                st.write(f"üìè Dimensiune: {image.size[0]}√ó{image.size[1]} px")
                st.write(f"üì¶ Format: {image.format}")
                st.write(f"üé® Mod: {image.mode}")
                
        except Exception as e:
            st.error(f"‚ùå Eroare la √ÆncƒÉrcarea imaginii: {e}")
    
    # Afi»ôare rezultate OCR
    if 'ocr_result' in st.session_state:
        result = st.session_state['ocr_result']
        
        if result.get('success'):
            # Tabs pentru rezultate
            tab1, tab2, tab3, tab4 = st.tabs(["üìù Text Extras", "üß¨ Valori Detectate", "‚ö° Auto-completare", "üìä AnalizƒÉ"])
            
            with tab1:
                st.markdown("**üìÑ Text complet extras din document:**")
                extracted_text = result.get('text', '')
                
                # Metrici text
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("üìä Caractere", len(extracted_text))
                with col2:
                    st.metric("üìù Cuvinte", len(extracted_text.split()))
                with col3:
                    st.metric("üî¢ Numere", len(re.findall(r'\d+(?:\.\d+)?', extracted_text)))
                with col4:
                    confidence = result.get('confidence', 0)
                    st.metric("üéØ Calitate", f"{confidence}%")
                
                # Text √Æn area editabilƒÉ
                st.text_area("", value=extracted_text, height=300, key="ocr_text_display", help="Textul extras din document. Poate fi editat manual dacƒÉ este necesar.")
                
                # Download text
                if extracted_text:
                    st.download_button(
                        "üì• DescarcƒÉ text extras",
                        data=extracted_text,
                        file_name=f"text_extras_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain"
                    )
            
            with tab2:
                extracted_data = result.get('extracted_data', {})
                
                if extracted_data:
                    st.markdown("**üß¨ Valori medicale detectate automat:**")
                    
                    # Valori numerice √Æntr-un tabel frumos
                    numeric_values = {k: v for k, v in extracted_data.items() 
                                    if isinstance(v, (int, float)) and k not in ['bacteria_found']}
                    
                    if numeric_values:
                        # Mapare nume friendly
                        friendly_names = {
                            'wbc': 'Leucocite (√ó10¬≥/ŒºL)',
                            'crp': 'CRP (mg/L)',
                            'procalcitonina': 'ProcalcitoninƒÉ (ng/mL)',
                            'temperatura': 'TemperaturƒÉ (¬∞C)',
                            'fc': 'Frecven»õa cardiacƒÉ (bpm)',
                            'tas': 'TAS (mmHg)',
                            'tad': 'TAD (mmHg)',
                            'hemoglobina': 'HemoglobinƒÉ (g/dL)',
                            'creatinina': 'CreatininƒÉ (mg/dL)'
                        }
                        
                        # CreeazƒÉ DataFrame pentru afi»ôare
                        display_data = []
                        for key, value in numeric_values.items():
                            display_data.append({
                                'Parametru': friendly_names.get(key, key.title()),
                                'Valoare': value,
                                'Observa»õii': get_value_interpretation(key, value)
                            })
                        
                        df_values = pd.DataFrame(display_data)
                        st.dataframe(df_values, use_container_width=True, hide_index=True)
                    
                    # Informa»õii microbiologice
                    if extracted_data.get('bacteria_found'):
                        st.markdown("**ü¶† Informa»õii microbiologice:**")
                        bacteria_name = extracted_data.get('bacteria_name', 'NedeterminatƒÉ')
                        st.success(f"üî¨ Bacterie detectatƒÉ: **{bacteria_name}**")
                        
                        if 'resistances' in extracted_data:
                            st.markdown("**üõ°Ô∏è Profile de rezisten»õƒÉ detectate:**")
                            for resistance in extracted_data['resistances']:
                                st.write(f"‚Ä¢ {resistance}")
                    
                    # JSON pentru dezvoltatori
                    with st.expander("üîß Date raw (JSON)"):
                        st.json(extracted_data)
                        
                else:
                    st.info("‚ÑπÔ∏è Nu s-au detectat valori medicale specifice √Æn document.")
                    st.markdown("**üí° Sfaturi pentru rezultate mai bune:**")
                    st.markdown("‚Ä¢ Asigura»õi-vƒÉ cƒÉ imaginea este clarƒÉ »ôi contrastatƒÉ")
                    st.markdown("‚Ä¢ Documentul ar trebui sƒÉ con»õinƒÉ valori numerice")
                    st.markdown("‚Ä¢ Textul sƒÉ fie √Æn rom√¢nƒÉ sau englezƒÉ")
            
            with tab3:
                st.markdown("**‚ö° Auto-completare formular EpiMind**")
                
                extracted_data = result.get('extracted_data', {})
                
                if extracted_data:
                    # Preview modificƒÉri
                    st.markdown("**üîÑ ModificƒÉri detectate pentru aplicare:**")
                    changes_preview = []
                    
                    value_mappings = {
                        'wbc': 'Leucocite',
                        'crp': 'CRP', 
                        'procalcitonina': 'ProcalcitoninƒÉ',
                        'temperatura': 'TemperaturƒÉ',
                        'fc': 'Frecven»õa cardiacƒÉ',
                        'hemoglobina': 'HemoglobinƒÉ',
                        'creatinina': 'CreatininƒÉ'
                    }
                    
                    for key, value in extracted_data.items():
                        if key in value_mappings and isinstance(value, (int, float)):
                            changes_preview.append(f"‚úì {value_mappings[key]}: {value}")
                    
                    if 'tas' in extracted_data and 'tad' in extracted_data:
                        changes_preview.append(f"‚úì Tensiune arterialƒÉ: {extracted_data['tas']}/{extracted_data['tad']} mmHg")
                    
                    if extracted_data.get('bacteria_found'):
                        bacteria_name = extracted_data.get('bacteria_name', 'NedeterminatƒÉ')
                        changes_preview.append(f"‚úì CulturƒÉ pozitivƒÉ: {bacteria_name}")
                        
                        if 'resistances' in extracted_data:
                            resistances = ', '.join(extracted_data['resistances'])
                            changes_preview.append(f"‚úì Rezisten»õe: {resistances}")
                    
                    if changes_preview:
                        for change in changes_preview:
                            st.markdown(change)
                        
                        st.markdown("---")
                        col1, col2, col3 = st.columns(3)
                        
                        with col1:
                            if st.button("‚úÖ AplicƒÉ Toate", key="apply_all", type="primary"):
                                apply_ocr_data_to_form(extracted_data)
                                st.success("üéâ Formularul a fost actualizat cu succes!")
                                st.balloons()
                                # Auto-navigheazƒÉ la analize
                                st.session_state['current_page'] = 'analize'
                                st.experimental_rerun()
                        
                        with col2:
                            if st.button("üìã AplicƒÉ Selectiv", key="apply_selective"):
                                st.session_state['selective_mode'] = True
                        
                        with col3:
                            if st.button("üëÄ Preview Rezultat", key="preview_result"):
                                # SimuleazƒÉ aplicarea pentru preview
                                temp_payload = collect_payload()
                                for key, value in extracted_data.items():
                                    if key == 'wbc':
                                        temp_payload['analize']['wbc'] = value
                                    elif key == 'bacteria_found' and value:
                                        temp_payload['cultura_pozitiva'] = True
                                        temp_payload['bacterie'] = extracted_data.get('bacteria_name', '')
                                
                                score, level, _, _ = calculate_iaam_risk(temp_payload)
                                st.info(f"üìä Scor IAAM estimat dupƒÉ aplicare: **{score}** (Nivel: **{level}**)")
                        
                        # Mod selectiv
                        if st.session_state.get('selective_mode'):
                            st.markdown("**üéØ Selec»õie manualƒÉ valori:**")
                            selected_values = {}
                            
                            for key, value in extracted_data.items():
                                if isinstance(value, (int, float)) or key == 'bacteria_name':
                                    col_check, col_desc = st.columns([1, 4])
                                    with col_check:
                                        selected = st.checkbox("", key=f"sel_{key}")
                                    with col_desc:
                                        if key == 'bacteria_name':
                                            st.write(f"ü¶† Bacterie: {value}")
                                        else:
                                            friendly_name = value_mappings.get(key, key.title())
                                            st.write(f"üìä {friendly_name}: {value}")
                                    
                                    if selected:
                                        selected_values[key] = value
                            
                            if st.button("‚úÖ AplicƒÉ Valorile Selectate", key="apply_selected"):
                                if selected_values:
                                    apply_ocr_data_to_form(selected_values)
                                    st.success(f"‚úÖ Au fost aplicate {len(selected_values)} valori!")
                                    st.session_state['selective_mode'] = False
                                else:
                                    st.warning("‚ö†Ô∏è Nu a»õi selectat nicio valoare!")
                    else:
                        st.info("‚ÑπÔ∏è Nu s-au detectat valori pentru auto-completare.")
                else:
                    st.info("‚ÑπÔ∏è Nu existƒÉ date pentru auto-completare. Procesa»õi mai √Ænt√¢i documentul.")
            
            with tab4:
                st.markdown("**üìä AnalizƒÉ detaliatƒÉ OCR**")
                
                # Statistici OCR
                text = result.get('text', '')
                confidence = result.get('confidence', 0)
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("**üìà Metrici calitate:**")
                    
                    # Bara de progres pentru confidence
                    if confidence >= 80:
                        st.success(f"üéØ √éncredere OCR: {confidence}% (ExcelentƒÉ)")
                    elif confidence >= 60:
                        st.warning(f"üéØ √éncredere OCR: {confidence}% (BunƒÉ)")
                    else:
                        st.error(f"üéØ √éncredere OCR: {confidence}% (SlabƒÉ)")
                    
                    st.progress(confidence / 100)
                    
                    # Analiza textului
                    medical_words = ['pacient', 'analiza', 'rezultat', 'valoare', 'normal', 'crescut', 'laborator', 'hemoglobina', 'leucocite']
                    found_medical = sum(1 for word in medical_words if word.lower() in text.lower())
                    
                    st.metric("üè• Termeni medicali", f"{found_medical}/{len(medical_words)}")
                    st.metric("üî¢ Valori numerice", len(re.findall(r'\d+(?:\.\d+)?', text)))
                    
                with col2:
                    st.markdown("**üí° RecomandƒÉri √ÆmbunƒÉtƒÉ»õire:**")
                    
                    recommendations = []
                    if confidence < 70:
                        recommendations.append("üì∏ Face»õi o fotografie mai clarƒÉ")
                        recommendations.append("üí° Asigura»õi-vƒÉ cƒÉ documentul este drept")
                        recommendations.append("üîÜ √émbunƒÉtƒÉ»õi»õi iluminarea")
                    
                    if len(text) < 100:
                        recommendations.append("üìÑ Verifica»õi cƒÉ tot documentul este vizibil")
                    
                    if found_medical < 3:
                        recommendations.append("üè• Verifica»õi cƒÉ este un document medical")
                    
                    if not recommendations:
                        st.success("‚úÖ Documentul a fost procesat optimal!")
                    else:
                        for rec in recommendations:
                            st.write(f"‚Ä¢ {rec}")
        else:
            st.error(f"‚ùå Eroare la procesarea documentului: {result.get('error', 'Eroare necunoscutƒÉ')}")
    
    st.markdown('</div>', unsafe_allow_html=True)

def get_value_interpretation(parameter: str, value: float) -> str:
    """ReturneazƒÉ interpretarea clinicƒÉ a unei valori"""
    interpretations = {
        'wbc': {
            'ranges': [(0, 4, "Leucopenie"), (4, 12, "Normal"), (12, float('inf'), "LeucocitozƒÉ")],
            'unit': '√ó10¬≥/ŒºL'
        },
        'crp': {
            'ranges': [(0, 3, "Normal"), (3, 10, "U»ôor crescut"), (10, 100, "Moderat crescut"), (100, float('inf'), "Foarte crescut")],
            'unit': 'mg/L'
        },
        'procalcitonina': {
            'ranges': [(0, 0.1, "Normal"), (0.1, 0.5, "Posibil infec»õie"), (0.5, 2, "Infec»õie probabilƒÉ"), (2, float('inf'), "Infec»õie severƒÉ")],
            'unit': 'ng/mL'
        },
        'temperatura': {
            'ranges': [(0, 36, "Hipotermie"), (36, 37.5, "Normal"), (37.5, 38.5, "FebrƒÉ u»ôoarƒÉ"), (38.5, float('inf'), "FebrƒÉ")],
            'unit': '¬∞C'
        },
        'fc': {
            'ranges': [(0, 60, "Bradicardie"), (60, 100, "Normal"), (100, float('inf'), "Tahicardie")],
            'unit': 'bpm'
        }
    }
    
    if parameter in interpretations:
        ranges = interpretations[parameter]['ranges']
        for min_val, max_val, interpretation in ranges:
            if min_val <= value < max_val:
                return interpretation
    
    return "Verifica»õi cu medicul"

# ---------------- PƒÉstra»õi toate paginile originale ----------------

def page_home():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h3>EpiMind ‚Äî Context, scop »ôi metodologie (cu OCR-NLP)</h3>', unsafe_allow_html=True)
    st.markdown(
        """
        <div class="small-muted">
        <strong>Context:</strong> Infec»õiile asociate asisten»õei medicale (IAAM) reprezintƒÉ un risc major pentru pacient
        »ôi o sursƒÉ semnificativƒÉ de morbiditate, mortalitate »ôi costuri spitalice»ôti. Screeningul proactiv faciliteazƒÉ
        identificarea timpurie a pacien»õilor cu risc crescut (MDR screening, izolare, antibioterapie direc»õionatƒÉ).
        <br/><br/>
        <strong>NoutƒÉ»õi v2.3.0:</strong> Integrare completƒÉ OCR-NLP pentru extragerea automatƒÉ de date din documente medicale.
        Sistemul poate procesa analize de laborator, rezultate microbiologice »ôi fi»ôe de observa»õie, identific√¢nd automat
        valorile relevante »ôi popul√¢nd formularul IAAM.
        <br/><br/>
        <strong>Scop:</strong> EpiMind oferƒÉ un instrument academic pentru triere »ôi suport decizional bazat pe reguli
        clinice »ôi scoruri validate (SOFA/qSOFA) combinate cu factori specifici spitalului: dispozitive invazive,
        durata internƒÉrii, culturi microbiologice »ôi comorbiditƒÉ»õi.
        <br/><br/>
        <strong>Metodologie:</strong> Motorul de evaluare este determinist ‚Äî combinƒÉ reguli temporale, greutƒÉ»õi pentru
        dispozitive invazive, penalizƒÉri pentru profiluri de rezisten»õƒÉ »ôi componente de severitate. Scorul rezultat
        este orientativ »ôi trebuie interpretat √Æn context clinic.
        </div>
        """,
        unsafe_allow_html=True,
    )
    st.markdown('<hr/>', unsafe_allow_html=True)
    st.markdown('<h4>üÜï Func»õionalitƒÉ»õi OCR-NLP</h4>', unsafe_allow_html=True)
    
    if OCR_AVAILABLE:
        cols = st.columns([1,1,1])
        with cols[0]:
            st.markdown('<div class="muted-box"><strong>üìÑ OCR Medical</strong><br/>Extragere automatƒÉ text din documente medicale scanate. Suport pentru rom√¢nƒÉ »ôi englezƒÉ cu preprocesare inteligentƒÉ.</div>', unsafe_allow_html=True)
        with cols[1]:
            st.markdown('<div class="muted-box"><strong>üß† NLP Avansat</strong><br/>AnalizƒÉ text pentru detectarea valorilor medicale, bacteriilor »ôi profilurilor de rezisten»õƒÉ folosind pattern recognition.</div>', unsafe_allow_html=True)
        with cols[2]:
            st.markdown('<div class="muted-box"><strong>‚ö° Auto-completare</strong><br/>Populare automatƒÉ a formularului IAAM cu datele extrase, cu validare »ôi preview √Ænainte de aplicare.</div>', unsafe_allow_html=True)
    else:
        st.warning("‚ö†Ô∏è Func»õionalitatea OCR-NLP nu este disponibilƒÉ. Instala»õi dependin»õele pentru func»õionalitate completƒÉ.")
    
    st.markdown('<hr/>', unsafe_allow_html=True)
    st.markdown('<h4>Module existente</h4>', unsafe_allow_html=True)
    cols = st.columns([1,1,1])
    with cols[0]:
        st.markdown('<div class="muted-box"><strong>Evaluare pacient</strong><br/>Introduce»õi date demografice, durata internƒÉrii »ôi sec»õia. Validare minimalƒÉ pentru simulƒÉri reproducibile.</div>', unsafe_allow_html=True)
    with cols[1]:
        st.markdown('<div class="muted-box"><strong>ComorbiditƒÉ»õi</strong><br/>Catalog structurat al afec»õiunilor principale (cardiovascular, respirator, metabolic etc.) cu greutƒÉ»õi predefinite pentru model.</div>', unsafe_allow_html=True)
    with cols[2]:
        st.markdown('<div class="muted-box"><strong>Microbiologie & UrinƒÉ</strong><br/>Permite introducerea rezultatelor culturilor, profilurilor de rezisten»õƒÉ »ôi interpretarea sedimentului urinar pentru suspiciune ITU.</div>', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

# PƒÉstra»õi toate celelalte pagini din fi»ôierul original:
# page_patient(), page_devices(), page_severity(), page_microbio(), 
# page_comorbid(), page_urine(), page_analize(), page_results_and_history()

# Pentru brevitate, includem doar page_patient ca exemplu:
def page_patient():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>Date pacient</h4>', unsafe_allow_html=True)
    c1, c2, c3 = st.columns([3,2,2])
    with c1:
        st.text_input('Nume / Cod pacient *', key='nume_pacient', placeholder='Pacient_001', help='Identificator pentru raport. Nu √ÆncƒÉrca date personale sensibile √Æn demo.')
        st.text_input('CNP (op»õional)', key='cnp', help='DacƒÉ este necesar pentru eviden»õƒÉ localƒÉ ‚Äî aten»õie la confiden»õialitate')
        st.selectbox('Sec»õia', ['ATI','Chirurgie','MedicinƒÉ InternƒÉ','Pediatrie','Neonatologie'], key='sectie')
    with c2:
        st.number_input('Ore internare *', min_value=0, max_value=10000, value=st.session_state.get('ore_spitalizare',96), key='ore_spitalizare', help='Criteriu temporal: IAAM >=48h')
        st.selectbox('Tip internare', ['Programat','Urgent'], key='tip_internare')
    with c3:
        st.date_input('Data evaluƒÉrii', key='data_evaluare')
        st.text_input('Cod intern (op»õional)', key='cod_intern')
    st.markdown('<div class="small-muted">C√¢mpurile cu * sunt esen»õiale.</div>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)

def page_devices():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>Dispozitive invazive (selecta»õi prezen»õa »ôi durata)</h4>', unsafe_allow_html=True)
    devices = ['CVC','Ventilatie','Sonda urinara','Traheostomie','Drenaj','PEG']
    cols = st.columns(3)
    for i, d in enumerate(devices):
        with cols[i % 3]:
            present = st.checkbox(d, key=f'disp_{d}')
            if present:
                st.number_input('Zile (duratƒÉ)', 0, 365, 3, key=f'zile_{d}')
    st.markdown('</div>', unsafe_allow_html=True)

def page_severity():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>Parametri clinici »ôi scoruri</h4>', unsafe_allow_html=True)
    c1, c2 = st.columns(2)
    with c1:
        st.number_input('PaO2/FiO2', 50, 500, value=st.session_state.get('pao2_fio2',400), key='pao2_fio2')
        st.number_input('Trombocite (x10^3/¬µL)', 0, 1000, value=st.session_state.get('trombocite',200), key='trombocite')
        st.number_input('BilirubinƒÉ (mg/dL)', 0.0, 30.0, value=st.session_state.get('bilirubina',1.0), key='bilirubina')
    with c2:
        st.number_input('Glasgow', 3, 15, value=st.session_state.get('glasgow',15), key='glasgow')
        st.number_input('CreatininƒÉ (mg/dL)', 0.1, 20.0, value=st.session_state.get('creatinina',1.0), key='creatinina')
        st.checkbox('Hipotensiune', key='hipotensiune')
        st.checkbox('Vasopresoare', key='vasopresoare')
    st.number_input('TAS (mmHg)', 40, 220, value=st.session_state.get('tas',120), key='tas')
    st.number_input('FR (/min)', 8, 60, value=st.session_state.get('fr',18), key='fr')
    st.markdown('<div class="small-muted">SOFA »ôi qSOFA sunt calculate automat pe baza acestor valori.</div>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)

def page_microbio():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>Microbiologie</h4>', unsafe_allow_html=True)
    cultura = st.checkbox('CulturƒÉ pozitivƒÉ', key='cultura_pozitiva')
    if cultura:
        st.selectbox('Agent patogen', [''] + list(REZISTENTA_PROFILE.keys()), key='bacterie')
        sel = st.session_state.get('bacterie', '')
        if sel:
            st.multiselect('Profil rezisten»õƒÉ', REZISTENTA_PROFILE.get(sel, []), key='profil_rezistenta')
    st.selectbox('Tip infec»õie (ICD-10)', list(ICD_CODES.keys()), key='tip_infectie')
    st.markdown('</div>', unsafe_allow_html=True)

def page_analize():
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<h4>Analize laborator ‚Äî markeri infec»õie »ôi inflama»õie</h4>', unsafe_allow_html=True)
    st.markdown('<div class="small-muted">Introduce»õi ultimele valori de laborator disponibile. Valorile introduse sunt utilizate pentru a ajusta scorul IAAM (orientativ).</div>', unsafe_allow_html=True)
    c1, c2, c3 = st.columns(3)
    with c1:
        st.number_input('Leucocite (WBC, x10^3/¬µL)', min_value=0.0, max_value=200.0, value=float(st.session_state.get('analize', {}).get('wbc', 8.0)), key='lab_wbc')
        st.number_input('Neutrofile absolute (x10^3/¬µL) ‚Äî (op»õional)', min_value=0.0, max_value=200.0, value=float(st.session_state.get('analize', {}).get('neut_abs', 5.0) or 0.0), key='lab_neut_abs')
        st.number_input('Neutrofile % (op»õional)', min_value=0.0, max_value=100.0, value=float(st.session_state.get('analize', {}).get('neut_pct', 70.0) or 0.0), key='lab_neut_pct')
    with c2:
        st.number_input('CRP (mg/L)', min_value=0.0, max_value=1000.0, value=float(st.session_state.get('analize', {}).get('crp', 20.0)), key='lab_crp')
        st.number_input('VSH / ESR (mm/h)', min_value=0.0, max_value=200.0, value=float(st.session_state.get('analize', {}).get('esr', 20.0)), key='lab_esr')
        st.number_input('ProcalcitoninƒÉ (ng/mL)', min_value=0.0, max_value=100.0, value=float(st.session_state.get('analize', {}).get('pct', 0.1)), key='lab_pct')
    with c3:
        st.number_input('PresepsinƒÉ (pg/mL) ‚Äî dacƒÉ este disponibil', min_value=0.0, max_value=20000.0, value=float(st.session_state.get('analize', {}).get('presepsin', 0.0)), key='lab_presepsin')
        st.number_input('Lactat (mmol/L)', min_value=0.0, max_value=20.0, value=float(st.session_state.get('analize', {}).get('lactate', 1.0)), key='lab_lactate')
        st.checkbox('HemoculturƒÉ pozitivƒÉ', key='lab_blood_culture')
    
    # save to session_state['analize']
    st.session_state['analize'] = {
        'wbc': st.session_state.get('lab_wbc'),
        'neut_abs': st.session_state.get('lab_neut_abs'),
        'neut_pct': st.session_state.get('lab_neut_pct'),
        'crp': st.session_state.get('lab_crp'),
        'esr': st.session_state.get('lab_esr'),
        'pct': st.session_state.get('lab_pct'),
        'presepsin': st.session_state.get('lab_presepsin'),
        'lactate': st.session_state.get('lab_lactate'),
        'blood_culture_positive': st.session_state.get('lab_blood_culture')
    }
    st.markdown('<div class="small-muted">Note: pragurile utilizate sunt orientative. Adapta»õi-le la protocoalele locale.</div>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)

# AdƒÉuga»õi celelalte pagini din fi»ôierul original...
# Pentru a economisi spa»õiu, le-am prescurtat, dar √Æn fi»ôierul final include»õi toate

def render_current_page():
    page = st.session_state.get('current_page','home')
    if page == 'home':
        page_home()
    elif page == 'patient':
        page_patient()
    elif page == 'ocr':  # PAGINƒÇ NOUƒÇ
        page_ocr()
    elif page == 'devices':
        page_devices()
    elif page == 'severity':
        page_severity()
    elif page == 'microbio':
        page_microbio()
    elif page == 'analize':
        page_analize()
    # elif page == 'comorbid':
    #     page_comorbid()
    # elif page == 'urine':
    #     page_urine()
    # elif page == 'results':
    #     page_results_and_history()
    else:
        st.info('Pagina nu existƒÉ')

# ---------------- Audit functions (pƒÉstrate din original) ----------------

def append_audit(result: Dict[str, Any]):
    """Append a single result to the local CSV audit file"""
    row = {
        'timestamp': result['timestamp'],
        'pacient': result['payload'].get('nume_pacient'),
        'sectie': result['payload'].get('sectie'),
        'ore_spitalizare': result['payload'].get('ore_spitalizare'),
        'scor': result['scor'],
        'nivel': result['nivel'],
        'agent': result['payload'].get('bacterie'),
        'rezistente': ','.join(result['payload'].get('profil_rezistenta', []))
    }
    df = pd.DataFrame([row])
    if not Path(AUDIT_CSV).exists():
        df.to_csv(AUDIT_CSV, index=False)
    else:
        df.to_csv(AUDIT_CSV, mode='a', header=False, index=False)

def load_audit_df() -> pd.DataFrame:
    if Path(AUDIT_CSV).exists():
        try:
            return pd.read_csv(AUDIT_CSV)
        except Exception:
            return pd.DataFrame()
    return pd.DataFrame()

# ---------------- Main function (enhanced) ----------------

def main():
    init_defaults()
    render_header()

    if st.session_state.get('show_nav', True):
        left, main_col = st.columns([1.2, 4])
        with left:
            render_nav()
        with main_col:
            render_current_page()
    else:
        render_current_page()

    # Footer cu ac»õiuni principale
    st.markdown('<hr/>', unsafe_allow_html=True)
    c1, c2, c3, c4 = st.columns([2, 1, 1, 3])
    
    with c1:
        if st.button('‚ñ∂Ô∏è EvalueazƒÉ riscul IAAM', key='compute_main', type='primary'):
            missing = []
            if not st.session_state.get('nume_pacient'):
                missing.append('Nume pacient')
            if st.session_state.get('ore_spitalizare',0) is None:
                missing.append('Ore spitalizare')
            if missing:
                st.error('Completa»õi: ' + ', '.join(missing))
            else:
                payload = collect_payload()
                scor, nivel, detalii, recomandari = calculate_iaam_risk(payload)
                result = {
                    'payload': payload,
                    'scor': scor,
                    'nivel': nivel,
                    'detalii': detalii,
                    'recomandari': recomandari,
                    'timestamp': datetime.now().isoformat()
                }
                st.session_state['last_result'] = result
                try:
                    append_audit(result)
                except Exception as e:
                    st.warning('Eroare scriere audit: ' + str(e))
                st.success(f'Calcul efectuat ‚Äî Scor: {scor} ‚Ä¢ Nivel: {nivel}')
                st.session_state['current_page'] = 'results'
                st.experimental_rerun()
    
    with c2:
        if st.button('üìÑ OCR', key='goto_ocr'):
            st.session_state['current_page'] = 'ocr'
            st.experimental_rerun()
    
    with c3:
        if st.button('üîÑ Reset', key='reset_main'):
            keys = [k for k in list(st.session_state.keys()) if k not in ('last_result','show_nav','current_page')]
            for k in keys:
                try:
                    del st.session_state[k]
                except Exception:
                    pass
            st.experimental_rerun()
    
    with c4:
        ocr_status = "üü¢ OCR-NLP Activ" if OCR_AVAILABLE else "üü° NecesitƒÉ instalare OCR-NLP"
        st.markdown(f'<div class="small-muted">EpiMind v{VERSION} ‚Ä¢ {ocr_status} ‚Ä¢ Demo academic ‚Ä¢ Datele se salveazƒÉ local (CSV).</div>', unsafe_allow_html=True)

if __name__ == '__main__':
    main()